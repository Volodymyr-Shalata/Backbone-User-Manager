<!DOCTYPE html>
<html>
    <head>
        <title>Backbone application</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.min.css">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.eot">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.svg">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.ttf">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.woff">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.woff2">

        <script src="libs/jquery.js"></script>
        <script src="libs/underscore.js"></script>
        <script src="libs/backbone.js"></script>
    </head>
        <!--<header class="navbar-inverse" role="banner">-->
            <!--<div class="container">-->
                <!--<nav class="navbar navbar-default" >-->
                    <!--<div class="container-fluid">-->
                        <!--&lt;!&ndash; Brand and toggle get grouped for better mobile display &ndash;&gt;-->
                        <!--<div class="navbar-header">-->
                            <!--<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">-->
                                <!--<span class="sr-only">Toggle navigation</span>-->
                                <!--<span class="icon-bar"></span>-->
                                <!--<span class="icon-bar"></span>-->
                                <!--<span class="icon-bar"></span>-->
                            <!--</button>-->
                            <!--<a class="navbar-brand" href="#">Brand</a>-->
                        <!--</div>-->

                        <!--&lt;!&ndash; Collect the nav links, forms, and other content for toggling &ndash;&gt;-->
                        <!--<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">-->
                            <!--<ul class="nav navbar-nav">-->
                                <!--<li class="active"><a href="#">Link <span class="sr-only">(current)</span></a></li>-->
                                <!--<li><a href="#">Link</a></li>-->
                                <!--<li class="dropdown">-->
                                    <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Dropdown <span class="caret"></span></a>-->
                                    <!--<ul class="dropdown-menu" role="menu">-->
                                        <!--<li><a href="#">Action</a></li>-->
                                        <!--<li><a href="#">Another action</a></li>-->
                                        <!--<li><a href="#">Something else here</a></li>-->
                                        <!--<li class="divider"></li>-->
                                        <!--<li><a href="#">Separated link</a></li>-->
                                        <!--<li class="divider"></li>-->
                                        <!--<li><a href="#">One more separated link</a></li>-->
                                    <!--</ul>-->
                                <!--</li>-->
                            <!--</ul>-->
                        <!--</div>&lt;!&ndash; /.navbar-collapse &ndash;&gt;-->
                    <!--</div>&lt;!&ndash; /.container-fluid &ndash;&gt;-->
                <!--</nav>-->
            <!--</div>-->
        <!--</header>-->

    <body>
        <div class="container">
            <div class="h1 text-info">User Manager</div>
            <hr />
            <!--<div class="col-sm-3">-->
                <!--<div class="panel panel-primary">-->
                    <!--<div class="panel-heading">Pannel Heading 1</div>-->
                    <!--<div class="panel-body">-->
                        <!--Basic panel example 1-->
                    <!--</div>-->
                <!--</div>-->
            <!--</div>-->
            <!--<div class="col-sm-3">-->
                <!--<div class="panel panel-success">-->
                    <!--<div class="panel-heading">Pannel Heading 2</div>-->
                    <!--<div class="panel-body">-->
                        <!--Basic panel example 2-->
                    <!--</div>-->
                <!--</div>-->
            <!--</div>-->

            <div class="page"></div>
        </div>
        
        <script type="text/template" id="user-list-template">
            <a href="#/new" class="btn btn-primary"><i class="glyphicon glyphicon-user"></i>&nbsp;New User</a>
            <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Age</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <% _.each(users,function(user){ %>
                    <tr class="info">
                        <td><%= user.get('Fname') %></td>
                        <td><%= user.get('Lname') %></td>
                        <td><%= user.get('Age') %></td>
                        <td><a href="#/edit/<%= user.id%>" class="btn btn-warning"><i class="glyphicon glyphicon-pencil"></i>&nbsp;   Edit</a></td>
                    </tr>
                <% }); %>
                
            </tbody>
            </table>
        
        </script>
        
        <script type="text/template" id="edit-user-template">
        <form class="edit-user-form form-horizontal">
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10 h2 text-info"><%= user ? 'Update ' : 'Create '%>User</div>
            </div>
            <div class="form-group">
                <label for="Fname" class="col-sm-2 control-label">First Name</label>
                <div class="col-sm-10">
                    <input type="text" id="Fname" name="Fname" value="<%= user ? user.attributes[0].Fname : '' %>" placeholder="Name...">
                </div>
            </div>
            <div class="form-group">
                <label for="Lname" class="col-sm-2 control-label">Last Name</label>
                <div class="col-sm-10">
                    <input type="text" id="Lname" name="Lname" value="<%= user ? user.attributes[0].Lname : '' %>" placeholder="Last Name...">
                </div>
            </div>
            <div class="form-group">
                <label for="Age" class="col-sm-2 control-label">Age</label>
                <div class="col-sm-10">
                    <input type="text" id="Age" name="Age" value="<%= user ? user.attributes[0].Age : '' %>" placeholder="Age...">
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button type="submit" class="btn btn-success"><i class="glyphicon glyphicon-user"><%= user ? 'Update ' : 'Create '%></i></button>
                    <% if(user) {%>
                    <input type="hidden" name="id" value="<%= user.id %>">
                    <button class="btn btn-danger delete" ><i class="glyphicon glyphicon-remove"></i>&nbsp;Delete</button>
                    <% }; %>
                </div>
            </div>
        </form>
        </script>
                
        <script>
            
        $.fn.serializeObject = function()
        {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function() {
                if (o[this.name] !== undefined) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };
            
            var Users = Backbone.Collection.extend({
               url: '/www/Backbone/users.php' 
            });
            
            var User = Backbone.Model.extend({
                urlRoot: '/www/Backbone/users.php'
            });
            
            //Here defined View
            var UserList = Backbone.View.extend({
               el: '.page',
               render: function(){
                   var users = {};
                   var self = this;
                   var users = new Users();
                   users.fetch({
                      success:function(users){
                          var template = _.template($('#user-list-template').html());
                          self.$el.html(template({'users': users.models})); 
                      } 
                   });
               }
            });
            
            var EditUser = Backbone.View.extend({
                el: '.page',
                render: function(option){
                    var that = this;
                    if(option.id){
                        that.user = new User({id : option.id});
                        that.user.fetch({
                            success:function(user){
                                var template = _.template($("#edit-user-template").html());
                                that.$el.html(template({user: user}));
                            }
                        });
                    }else{
                        var template = _.template($('#edit-user-template').html());
                        that.$el.html(template({user: null}));
                    }
                },
                events:{
                    'submit .edit-user-form': 'saveUser',
                    'click .delete': 'deleteUser'
                },
                saveUser: function(ev){
                    var userDetails = $(ev.currentTarget).serializeObject();
                    var user = new User();
                    user.save(userDetails,{success: function(){
                        router.navigate('',{trigger:true});
                    },
                    error: function(e){console.log(e);}
                    });
                    return false;
                },
                deleteUser:function(ev){
                    this.user.destroy({
                        success: function(){
                            router.navigate('',{trigger:true});
                        }
                    })
                    return false;
                },
                wait:true
            });
            
            //Define Backbone router obj
            var Router = Backbone.Router.extend({
                routes:{
                    //'' - means home directory
                    '': 'home',
                    'new': 'editUser',
                    'edit/:id': 'editUser'
                }
            });
            
            var router = new Router();
            var userList = new UserList();
            var editUser = new EditUser();
            router.on('route:home',function(){
                //when we go to the home directory, backbone router see that its calles home
                //and bind it with this event, in witch we launch render function to the userlist object
                //that defined in userLIst object, and insert data into the template
                userList.render();
            });
            router.on('route:editUser',function(id){
                editUser.render({id: id});
            });
            
            Backbone.history.start();
        </script>
    </body>
    
</html>

<!DOCTYPE html>
<html>
    <head>
        <title>Backbone application</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.min.css">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.eot">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.svg">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.ttf">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.woff">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.woff2">

        <script src="libs/jquery.js"></script>
        <script src="libs/underscore.js"></script>
        <script src="libs/backbone.js"></script>
    </head>


    <body>
    <div class="navbar navbar-inverse">
        <div class="container">
            <button class="navbar-toggle" data-toggle="collapse" data-target=".navHeaderCollapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div class="collapse navbar-collapse navHeaderCollapse">
                <ul class="nav navbar-nav navbar-left">
                    <li class="active"><a href="#">Home</a></li>
                    <li class="active"><a href="#" id="userManager">User Manager</a></li>
                    <li><a href="#">Blog</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Social Media <span class="caret"></span></a>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="#">VK</a></li>
                            <li><a href="#">Facebook</a></li>
                            <li><a href="#">Linkedin</a></li>
                            <li><a href="#">Odnoclasniki</a></li>
                            <li><a href="#">Twitter</a></li>
                        </ul>
                    </li>
                    <li><a href="#">About</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </div>
            </div>
    </div>
        <div class="container">
            <div class="h1 text-info">User Manager</div>
            <hr />
            <div class="page"></div>
        </div>
        
        <script type="text/template" id="user-list-template">
            <a href="#/new" class="btn btn-primary"><i class="glyphicon glyphicon-user"></i>&nbsp;New User</a>
            <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Age</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <% _.each(users,function(user){ %>
                    <tr class="info">
                        <td><%= user.get('Fname') %></td>
                        <td><%= user.get('Lname') %></td>
                        <td><%= user.get('Age') %></td>
                        <td><a href="#/edit/<%= user.id%>" class="btn btn-warning"><i class="glyphicon glyphicon-pencil"></i>&nbsp;   Edit</a></td>
                    </tr>
                <% }); %>
                
            </tbody>
            </table>
        
        </script>
        
        <script type="text/template" id="edit-user-template">
        <form class="edit-user-form form-horizontal">
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10 h2 text-info"><%= user ? 'Update ' : 'Create '%>User</div>
            </div>
            <div class="form-group">
                <label for="Fname" class="col-sm-2 control-label">First Name</label>
                <div class="col-sm-10">
                    <input type="text" id="Fname" name="Fname" value="<%= user ? user.attributes[0].Fname : '' %>" placeholder="Name...">
                </div>
            </div>
            <div class="form-group">
                <label for="Lname" class="col-sm-2 control-label">Last Name</label>
                <div class="col-sm-10">
                    <input type="text" id="Lname" name="Lname" value="<%= user ? user.attributes[0].Lname : '' %>" placeholder="Last Name...">
                </div>
            </div>
            <div class="form-group">
                <label for="Age" class="col-sm-2 control-label">Age</label>
                <div class="col-sm-10">
                    <input type="text" id="Age" name="Age" value="<%= user ? user.attributes[0].Age : '' %>" placeholder="Age...">
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button type="submit" class="btn btn-success"><i class="glyphicon glyphicon-user"><%= user ? 'Update ' : 'Create '%></i></button>
                    <% if(user) {%>
                    <input type="hidden" name="id" value="<%= user.id %>">
                    <button class="btn btn-danger delete" ><i class="glyphicon glyphicon-remove"></i>&nbsp;Delete</button>
                    <% }; %>
                </div>
            </div>
        </form>
        </script>

    <script type="text/template" id="subscribe-email">
        <form class="subscribe-email">
            <div class="pull-right">
                    <input type="email" placeholder="Enter your email..." id="emailField" >
                    <button class="btn btn-danger pull-right" type="submit" id="subscrb" >Subscribe</button>
                <% if(email) {%>
                    <% if(email.attributes.error) {%>
                            <div class="alert alert-danger">
                                <%= email.attributes.error %>
                                <a href="#"  onclick="$(this).parent().addClass('hide')">
                                    <i class="glyphicon glyphicon-remove"></i>
                                </a>
                            </div>
                    <% }; %>
                    <% if(email.attributes.msg) {%>
                        <div class="text-primary bg-success">
                            <%= email.attributes.msg %>
                            <a href="#" onclick="$(this).parent().addClass('hide')">
                                <i class="glyphicon glyphicon-remove"></i>
                            </a>
                        </div>
                    <% }; %>
                <% }; %>
            </div>
        </form>
    </script>

    <div class="navbar navbar-inverse navbar-fixed-bottom">
        <div class="container footer ">
            <div class="navbar-text pull-left">My site</div>
            <div class="pull-right email_subscription">
            </div>
        </div>
    </div>
                
        <script>
            
        $.fn.serializeObject = function()
        {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function() {
                if (o[this.name] !== undefined) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };

            var Emails = Backbone.Model.extend({
                url: '/www/Backbone/email.php'
            });
            
            var Users = Backbone.Collection.extend({
               url: '/www/Backbone/users.php' 
            });
            
            var User = Backbone.Model.extend({
                urlRoot: '/www/Backbone/users.php'
            });
            
            //Here defined View
            var UserList = Backbone.View.extend({
               el: '.page',
               render: function(){
                   var users = {};
                   var self = this;
                   var users = new Users();
                   users.fetch({
                      success:function(users){
                          var template = _.template($('#user-list-template').html());
                          self.$el.html(template({'users': users.models})); 
                      } 
                   });
               }
            });
            
            var EditUser = Backbone.View.extend({
                el: '.page',
                render: function(option){
                    var that = this;
                    if(option.id){
                        that.user = new User({id : option.id});
                        that.user.fetch({
                            success:function(user){
                                var template = _.template($("#edit-user-template").html());
                                that.$el.html(template({user: user}));
                            }
                        });
                    }else{
                        var template = _.template($('#edit-user-template').html());
                        that.$el.html(template({user: null}));
                    }
                },
                events:{
                    'submit .edit-user-form': 'saveUser',
                    'click .delete': 'deleteUser'
                },
                saveUser: function(ev){
                    var userDetails = $(ev.currentTarget).serializeObject();
                    var user = new User();
                    user.save(userDetails,{success: function(){
                        router.navigate('',{trigger:true});
                    },
                    error: function(e){console.log(e);}
                    });
                    return false;
                },
                deleteUser:function(ev){
                    this.user.destroy({
                        success: function(){
                            router.navigate('',{trigger:true});
                        }
                    })
                    return false;
                },
                wait:true
            });

            var SubscrEmail = Backbone.View.extend({
                el: ' .email_subscription',
                render: function(email){
                    if(email){
                        var template = _.template($("#subscribe-email").html());
                        this.$el.html(template({email: email}));
                    }else{
                        var template = _.template($("#subscribe-email").html());
                        this.$el.html(template({email: null}));
                    }
                },
                events:{
                    'submit .subscribe-email': 'addEmail'
                },
                addEmail: function(ev){
                    var that = this;
                    var emailVal = $("#emailField").val();
                    var email = new Emails();
                    email.save({'email': emailVal}, {success:function(email){
                        that.render(email);
                    }});
                    return false;
                }

            });
            
            //Define Backbone router obj
            var Router = Backbone.Router.extend({
                routes:{
                    //'' - means home directory
                    '': 'home',
                    'new': 'editUser',
                    'edit/:id': 'editUser'
                }
            });
            
            var router = new Router();
            var userList = new UserList();
            var editUser = new EditUser();
            var subscrEmail = new SubscrEmail();
            router.on('route:home',function(){
                //when we go to the home directory, backbone router see that its calles home
                //and bind it with this event, in witch we launch render function to the userlist object
                //that defined in userLIst object, and insert data into the template
                userList.render();
                subscrEmail.render();
            });
            router.on('route:editUser',function(id){
                editUser.render({id: id});
            });
            
            Backbone.history.start();
        </script>
    </body>
    
</html>

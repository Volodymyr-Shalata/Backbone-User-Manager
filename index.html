<!DOCTYPE html>
<html>
    <head>
        <title>Backbone application</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="css.css">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.eot">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.svg">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.ttf">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.woff">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/fonts/glyphicons-halflings-regular.woff2">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-modal/2.2.5/css/bootstrap-modal.css">

        <script src="libs/jquery.js"></script>
        <script src="libs/underscore.js"></script>
        <script src="libs/backbone.js"></script>
        <script src="functions.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <script src="libs/jquery.confirm.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.4/js/bootstrap-dialog.min.js"></script>
    </head>

    <body>
    <div class="navbar navbar-inverse">
        <div class="container">
            <button class="navbar-toggle" data-toggle="collapse" data-target=".navHeaderCollapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div class="collapse navbar-collapse navHeaderCollapse">
                <ul class="nav navbar-nav navbar-left">
                    <li class="active"><a href="#/home">Home</a></li>
                    <li class="active"><a href="#/userManager" id="userManager">User Manager</a></li>
                    <li><a href="#">Blog</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Social Media <span class="caret"></span></a>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="#">VK</a></li>
                            <li><a href="#">Facebook</a></li>
                            <li><a href="#">Linkedin</a></li>
                            <li><a href="#">Odnoclasniki</a></li>
                            <li><a href="#">Twitter</a></li>
                        </ul>
                    </li>
                    <li><a href="#">About</a></li>
                    <li><a href="#">Contact</a></li>
                    <li><a href="#/login">Login</a></li>
                </ul>
            </div>
            </div>
    </div>

    <div class="container">
        <div class="page"></div>
    </div>

    <script type="text/template" id="home-page">
        <div class="text-info">
            <h1>Home Page</h1>
        </div>
        <% if(data) {%>
            <%= data.home %>
        <% };%>
    </script>
        
    <script type="text/template" id="user-list-template">
        <div class="text-info">
            <h1>User Manager</h1>
            <hr />
        </div>
        <a href="#/new" class="btn btn-primary"><i class="glyphicon glyphicon-user"></i>&nbsp;New User</a>
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Age</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <% _.each(users,function(user){ %>
                    <tr class="info">
                        <td><%= user.get('Fname') %></td>
                        <td><%= user.get('Lname') %></td>
                        <td><%= user.get('Age') %></td>
                        <td><a href="#/edit/<%= user.id%>" class="btn btn-warning"><i class="glyphicon glyphicon-pencil"></i>&nbsp;   Edit</a></td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </script>
        
    <script type="text/template" id="edit-user-template">
        <form class="edit-user-form form-horizontal">
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10 h2 text-info"><%= user ? 'Update ' : 'Create '%>User</div>
            </div>
            <div class="form-group">
                <label for="Fname" class="col-sm-2 control-label">First Name</label>
                <div class="col-sm-10">
                    <input type="text" id="Fname" name="Fname" value="<%= user ? user.attributes[0].Fname : '' %>" placeholder="Name...">
                </div>
            </div>
            <div class="form-group">
                <label for="Lname" class="col-sm-2 control-label">Last Name</label>
                <div class="col-sm-10">
                    <input type="text" id="Lname" name="Lname" value="<%= user ? user.attributes[0].Lname : '' %>" placeholder="Last Name...">
                </div>
            </div>
            <div class="form-group">
                <label for="Age" class="col-sm-2 control-label">Age</label>
                <div class="col-sm-10">
                    <input type="text" id="Age" name="Age" value="<%= user ? user.attributes[0].Age : '' %>" placeholder="Age...">
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button type="submit" class="btn btn-success"><i class="glyphicon glyphicon-user"><%= user ? 'Update ' : 'Create '%></i></button>
                    <% if(user) {%>
                    <input type="hidden" name="id" value="<%= user.id %>">
                    <button class="btn btn-danger delete" ><i class="glyphicon glyphicon-remove"></i>&nbsp;Delete</button>
                    <% }; %>
                </div>
            </div>
        </form>
    </script>

    <script type="text/template" id="subscribe-email">
        <form class="subscribe-email">
            <div class="pull-right">
                <input type="text" placeholder="Enter your email..." id="emailField" >
                <button class="btn btn-danger pull-right" type="submit" id="subscrb" style="padding:2px">Subscribe</button>
                <% if(email) {%>
                    <% if(email.attributes.error) {%>
                        <div>
                            <button class="btn btn-primary btn-block confirm" type="button">Unsubscribe from newsletter</button>
                        </div>
                    <% }; %>
                    <% if(email.attributes.msg) {%>
                        <div class="alert alert-block alert-success" style="font-size:11px">
                            <%= email.attributes.msg %>
                            <a class="close" data-dismiss="alert" href="#" onclick="$(this).parent().addClass('hide')">
                                <i class="glyphicon glyphicon-remove"></i>
                            </a>
                        </div>
                    <% }; %>
                <% }; %>
                <% if (error){%>
                    <div class="alert alert-danger">
                        <%= error %>
                        <a href="#"  onclick="$(this).parent().addClass('hide')">
                            <i class="glyphicon glyphicon-remove"></i>
                        </a>
                    </div>
                <% };%>
            </div>
        </form>
    </script>

    <script type="text/template" id="login-template">
        <div class="text-center vcenter">
            <form id="login">
                <% if(login) {%>
                    <% if(login.attributes.error) {%>
                    <div class="row">
                        <div class="col-md-4 col-md-offset-4">
                            <div class="alert alert-block alert-danger">
                                <a class="close" data-dismiss="alert" href="#" onclick="$(this).parent().parent().parent().addClass('hide')">X</a>
                                Incorrect Login or Password
                            </div>
                        </div>
                    </div>
                    <% };%>
                <% }; %>
                 <div class="form-group margin-left-30">
                    <label for="userName">Login</label>
                    <input type="text" name="userName" id="userName" placeholder="Login...">
                 </div>
                 <div class="form-group">
                    <label for="userPass">Password</label>
                    <input type="text" name="userPass" id="userPass" placeholder="Password...">
                 </div>
                 <div class="form-group">
                    <button class="btn btn-primary" id="loginBtn">Log In</button>
                 </div>
                <input type="hidden" name="operation" value="login">
            </form>
        </div>
    </script>

    <div class="navbar navbar-inverse navbar-fixed-bottom">
        <div class="container footer ">
            <div class="navbar-text pull-left">My site</div>
            <div class="pull-right email_subscription" style="padding-top:10px">
            </div>
        </div>
    </div>
                
    <script>

        var Emails = Backbone.Model.extend({
            url: '/www/Backbone/email.php',

            validate_email: function(){
                var errors = {};
                var emailVal = $("#emailField").val();
                var valid_email = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
                if(!emailVal.match(valid_email)){
                    errors = {error: "Please, enter the valid email", email: emailVal};
                }else{
                    errors = {error: "", email: emailVal};
                }
                return errors;
            }

        });
            
        var Users = Backbone.Collection.extend({
           url: '/www/Backbone/users.php'
        });
            
        var User = Backbone.Model.extend({
            urlRoot: '/www/Backbone/users.php'
        });

        var Home = Backbone.Model.extend({
            urlRoot: '/www/Backbone/home.php'
        });

        var UserLogin = Backbone.Model.extend({
            urlRoot: '/www/Backbone/login.php'
        });
            
        //Here defined View
        var UserList = Backbone.View.extend({
           el: '.page',
           render: function(){
               var self = this;
               var users = new Users();
               users.fetch({success:function(users){
                    var template = _.template($('#user-list-template').html());
                    self.$el.html(template({'users': users.models}));
               }});
           }
        });
            
        var EditUser = Backbone.View.extend({
            el: '.page',

            render: function(option){
                var that = this;
                if(option.id){
                    that.user = new User({id : option.id});
                    that.user.fetch({
                    success:function(user){
                        var template = _.template($("#edit-user-template").html());
                        that.$el.html(template({user: user}));
                    }});
                }else{
                    var template = _.template($('#edit-user-template').html());
                    that.$el.html(template({user: null}));
                }
            },

            events:{
                'submit .edit-user-form': 'saveUser',
                'click .delete': 'deleteUser'
             },

            saveUser: function(ev){
                var userDetails = $(ev.currentTarget).serializeObject();
                var user = new User();
                user.save(userDetails,{success: function(){
                    router.navigate('userManager',{trigger:true});
                },
                    error: function(e){console.log(e);}
                });
                    return false;
                },
            deleteUser:function(ev){
                this.user.destroy({
                success: function(){
                    router.navigate('userManager',{trigger:true});
                }})
                return false;
            },wait:true
            });

        var SubscrEmail = Backbone.View.extend({
            el: ' .email_subscription',
            render: function(email, error){
                    if(email != null && typeof error != undefined){
                        var template = _.template($("#subscribe-email").html());
                        if(typeof email.attributes.error != undefined ){
                            this.$el.html(template({email: email, error:null}));

                            var el = $(".confirm");
                            var that = this;
                            var confEmail = new Emails();
                            $(".confirm").click(function(){
                                BootstrapDialog.confirm({
                                    type: BootstrapDialog.TYPE_WARNING, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
                                    title: 'Unsubscribing',
                                    message: 'Do you want to unsubscribe from newsletter?',
                                    closable: true, // <-- Default value is false
                                    draggable: true, // <-- Default value is false
                                    btnOKLabel: 'Yes', // <-- Default value is 'OK',
                                    btnCancelLabel: 'No', // <-- Default value is 'Cancel',
                                    btnOKClass: 'btn-warning',
                                    callback: function(result) {
                                        // result will be true if button was click, while it will be false if users close the dialog directly.
                                        if(result) {
                                            confEmail.save({email :email.attributes.email, operation: 'unsubscr'},{success:function(data){
                                                BootstrapDialog.show({
                                                    type: this.TYPE_SUCCESS,
                                                    title: 'Unsubscribing confirmation',
                                                    message: 'You are successfully unsubscribed from the newsletter!',
                                                    buttons: [{
                                                        id: 'btn-ok',
                                                        label: 'OK',
                                                        cssClass: 'btn-success',
                                                        autospin: false,
                                                        action: function(dialogRef){
                                                            dialogRef.close();
                                                        }
                                                    }]
                                                });
                                                el.addClass('hide');
                                            }});
                                        }else {
                                            el.addClass('hide');
                                        }
                                    }
                                });
                            });
                        }
                    }else{
                        var template = _.template($("#subscribe-email").html());
                        this.$el.html(template({email: null, error:null}));
                    }
                    if(error){
                        var template = _.template($("#subscribe-email").html());
                        this.$el.html(template({email:null,error: error}));
                    }
            },

            events:{
                'submit .subscribe-email': 'addEmail'
            },

            addEmail: function(){
                var that = this;
                var email = new Emails();
                var errors = email.validate_email();
                if(errors.error =='' && errors.email){
                    email.save({'email': errors.email, operation: 'addEmail'}, {success:function(email){
                        that.render(email);
                    }});
                }else{
                    that.render(null,errors.error);
                }
                return false;
            }
        });

        var HomePage = Backbone.View.extend({
            el: '.page',
            render: function(){
                var home = new Home();
                var that = this;
                home.fetch({
                    success: function(data){
                        var template= _.template($("#home-page").html());
                        that.$el.html(template({data: data}));
                }});
            }
        });

        var LoginView = Backbone.View.extend({
            el: '.page',

            events:{
                'click #loginBtn': 'login_press'
            },

            render: function(loginData){
                var userLogin = new UserLogin();
                var that = this;

                if(loginData){
                    userLogin.save(loginData,
                        {success: function(data){
                            var template = _.template($("#login-template").html());
                            that.$el.html(template({login: data}));
                            if(data.attributes[0].role == 'admin'){
                                router.navigate('userManager', {trigger:true});
                            }else{
                                router.navigate('home', {trigger:true});
                            }
                        }}
                    )
                }else{
                    var template = _.template($("#login-template").html());
                    that.$el.html(template({login: null}));
                }

            },

            login_press: function(e){
                e.preventDefault();
                var loginData = $("#login").serializeObject();
                if(loginData.length !=0){
                    this.render(loginData);
                }
            }

        });
            
        //Define Backbone router obj
        var Router = Backbone.Router.extend({
            routes:{
                //'' - means home directory
                'home': 'home',
                'userManager': 'userManager',
                'new': 'editUser',
                'edit/:id': 'editUser',
                'login' : 'login'
            }
        });
            
        var router = new Router();
        var userList = new UserList();
        var editUser = new EditUser();
        var subscrEmail = new SubscrEmail();
        var homePage = new HomePage();
        var login = new LoginView();

        //Always render email View
        subscrEmail.render();

        router.on('route:userManager',function(){
            //when we go to the home directory, backbone router see that its calles home
            //and bind it with this event, in witch we launch render function to the userlist object
            //that defined in userLIst object, and insert data into the template
            userList.render();
        });
        router.on('route:editUser',function(id){
            editUser.render({id: id});
        });
        router.on('route:home', function(){
            homePage.render();
        });
        router.on('route:login', function(){
            login.render();
        });
            
            Backbone.history.start();
    </script>

    </body>
    
</html>
